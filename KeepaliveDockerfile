FROM google/cloud-sdk
FROM gcr.io/google-appengine/openjdk:8

RUN apt-get update
RUN apt-get install -y software-properties-common
RUN apt-get install -y nginx openssh-server git-core openssh-client curl
RUN apt-get install -y nano
RUN apt-get install -y build-essential
RUN apt-get install -y openssl zlib1g zlib1g-dev libssl-dev libyaml-dev \
    libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake \
    libtool pkg-config python python-dev python-pip
RUN apt-get install -y wget

RUN pip install supervisor

WORKDIR /
RUN wget http://apache.claz.org/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz
RUN tar zxvf apache-maven-3.3.9-bin.tar.gz
RUN chmod +x apache-maven-3.3.9/bin/mvn
RUN export M2_HOME=/apache-maven-3.3.9
RUN export PATH="/apache-maven-3.3.9/bin:${PATH}"
ENV PATH="/apache-maven-3.3.9/bin:${PATH}"

ADD . /mlab-vis-pipeline

# setup nginx
COPY templates/nginx.conf /etc/nginx/nginx.conf
RUN service nginx start
EXPOSE 80

ENV DOCKER_HOST unix:///var/run/docker.sock

# build jar
WORKDIR /mlab-vis-pipeline
RUN make build

# setup jobs queue
RUN touch /var/log/supervisor.log
RUN touch /var/log/jobs.log
WORKDIR /mlab-vis-pipeline/job_scheduler
RUN pip install -r requirements.txt
WORKDIR /mlab-vis-pipeline
COPY templates/supervisord.conf /etc/supervisor/supervisord.conf

CMD ["/bin/sh", "-c", "service nginx restart && /usr/local/bin/supervisord --configuration /etc/supervisor/supervisord.conf"]
